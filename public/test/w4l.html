<html><body>

<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

Step 1:<br>
<form id="step1Form">
  First Name: <input type="text" name="firstName" value="john1"><br>
  Last Name: <input type="text" name="lastName" value="doe"><br>
  Email: <input type="text" name="email" value="john1@doe.com"><br>
  Amount: <input type="text" name="amount" value="11"><br>
  <input id="step1Submit" type="submit" value="Next">
</form>
<br>
Step 2:
<form id="step2Form">
  Contribution Id: <input id="contributionId" type="text" name="contributionId"><br>
  Card Number: <input type="text" name="cardNumber"><br>
  Card Exp Month: <input type="text" name="cardExpMonth"><br>
  Card Exp Year: <input type="text" name="cardExpYear"><br>
  Card CVV: <input type="text" name="cardCvv"><br>
  Billing Zip: <input type="text" name="billingZip"><br>
  <input id="step2Submit" type="submit" value="Submit">
</form>
<br>
Payment Id: <div id="paymentId"></div><br>


<script>
  $("#step1Form").submit(handleStep1);
  $("#step2Form").submit(handleStep2);

//  var endpoint = 'http://seedbombing.dev.colab.coop';
//  var campaignId = 'NkvHV25Ql';
//  var endpoint = 'http://localhost:8000';
//  var campaignId = 'VJ7iA5cQg';

  var endpoint = 'http://seed.stage.colab.coop';
  var campaignId = 'N1bm2FjXx';
  var apiKey = 'w4l';


  function handleStep1() {
    var form = document.getElementById("step1Form");
    var data = {campaignId: campaignId};
    copyFormValues(data, form, ['firstName','lastName','email','amount']);
    submitPledge(data, handlePledgeResponse);
    return false;
  }

  function handlePledgeResponse(data) {
    var contributionId = data.result.contributionId;
//    alert('contributionId: ' + contributionId);
    $('#contributionId').val(contributionId);
  }


  function handleStep2() {
    var form = document.getElementById("step2Form");
    var data = {};
    copyFormValues(data, form, ['contributionId','cardNumber','cardExpMonth','cardExpYear','cardCvv','billingZip']);
    submitPaymentInfo(data, handlePaymentInfoResponse);
    return false;
  }

  function handlePaymentInfoResponse(data) {
    var paymentId = data.result.paymentId;
//    alert('paymentId: ' + paymentId);
    $('#paymentId').html(paymentId);
  }


  function submitPledge(data, successHandler) {
    var uri = '/api/v1/campaign/' + data.campaignId + '/pledge.submit';
    invoke(uri, data, successHandler);
  }

  function submitPaymentInfo(data, successHandler) {
    var uri = '/api/v1/contribution/' + data.contributionId + '/paymentInfo.submit';
    invoke(uri, data, successHandler);
  }

  function invoke(uri, data, successHandler) {
    var url = endpoint + uri;
    data.apiKey = apiKey;
    $.ajax({
      url: url
      , dataType: 'jsonp'
      , data: data
      , success: successHandler
      , error: function(xhr, status, error) { alert(status) }
    });
  }


  function copyFormValues(data, form, fields) {
    for (i = 0; i < fields.length; i++) {
      data[fields[i]] = formValue(form, fields[i]);
    }
  }

  function formValue(form, field) {
    return form.elements[field].value;
  }


</script>


</body></html>
